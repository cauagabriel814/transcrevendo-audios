# Configuração Nginx para Audio Transcription Service
# Este arquivo deve ser copiado para /etc/nginx/sites-available/audio-transcription
# ou /etc/nginx/conf.d/audio-transcription.conf

upstream transcription_backend {
    server 127.0.0.1:8000;
    keepalive 64;
}

server {
    listen 80;
    server_name _;  # Substituir pelo seu domínio (ex: api.seudominio.com)

    # Logs
    access_log /var/log/nginx/audio_transcription_access.log;
    error_log /var/log/nginx/audio_transcription_error.log;

    # ============================================
    # TIMEOUTS - CRÍTICOS PARA TRANSCRIÇÕES LONGAS
    # ============================================

    # Timeouts do cliente (navegador/app)
    client_body_timeout 600s;      # 10 minutos - tempo para enviar o body completo
    client_header_timeout 600s;    # 10 minutos - tempo para enviar headers
    send_timeout 600s;             # 10 minutos - tempo para enviar resposta ao cliente
    keepalive_timeout 600s;        # 10 minutos - manter conexão aberta

    # ============================================
    # LIMITES DE TAMANHO - PARA ARQUIVOS GRANDES
    # ============================================

    client_max_body_size 150M;         # Máximo 150MB (para base64)
    client_body_buffer_size 150M;      # Buffer de 150MB

    # ============================================
    # LOCATION / - PROXY PARA FASTAPI
    # ============================================

    location / {
        # Proxy para uvicorn
        proxy_pass http://transcription_backend;

        # ============================================
        # TIMEOUTS DO PROXY - MAIS CRÍTICOS AINDA
        # ============================================

        proxy_read_timeout 600s;       # 10 minutos - tempo para ler resposta do backend
        proxy_connect_timeout 600s;    # 10 minutos - tempo para conectar ao backend
        proxy_send_timeout 600s;       # 10 minutos - tempo para enviar dados ao backend

        # ============================================
        # HEADERS HTTP - IMPORTANTES PARA PROXY
        # ============================================

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection "";

        # ============================================
        # HTTP VERSION E KEEP-ALIVE
        # ============================================

        proxy_http_version 1.1;

        # ============================================
        # BUFFERING - DESABILITADO PARA STREAMING
        # ============================================

        proxy_buffering off;
        proxy_request_buffering off;

        # ============================================
        # WEBSOCKET SUPPORT (FUTURO)
        # ============================================

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # ============================================
    # HEALTH CHECK ENDPOINT (SEM AUTENTICAÇÃO)
    # ============================================

    location /health {
        proxy_pass http://transcription_backend;
        proxy_read_timeout 10s;
        proxy_connect_timeout 10s;
        access_log off;  # Não logar health checks
    }

    # ============================================
    # LOCATION /docs - SWAGGER UI
    # ============================================

    location /docs {
        proxy_pass http://transcription_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /redoc {
        proxy_pass http://transcription_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /openapi.json {
        proxy_pass http://transcription_backend;
        proxy_set_header Host $host;
    }
}

# ============================================
# CONFIGURAÇÃO HTTPS (OPCIONAL - PARA PRODUÇÃO)
# ============================================
#
# Descomente e configure após obter certificado SSL com certbot
#
# server {
#     listen 443 ssl http2;
#     server_name api.seudominio.com;
#
#     # Certificados SSL (Let's Encrypt)
#     ssl_certificate /etc/letsencrypt/live/api.seudominio.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/api.seudominio.com/privkey.pem;
#
#     # Configurações SSL recomendadas
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#
#     # Logs
#     access_log /var/log/nginx/audio_transcription_ssl_access.log;
#     error_log /var/log/nginx/audio_transcription_ssl_error.log;
#
#     # Mesmos timeouts e configurações do server HTTP acima
#     client_body_timeout 600s;
#     client_header_timeout 600s;
#     send_timeout 600s;
#     keepalive_timeout 600s;
#     client_max_body_size 150M;
#     client_body_buffer_size 150M;
#
#     location / {
#         proxy_pass http://transcription_backend;
#         proxy_read_timeout 600s;
#         proxy_connect_timeout 600s;
#         proxy_send_timeout 600s;
#
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header Connection "";
#
#         proxy_http_version 1.1;
#         proxy_buffering off;
#         proxy_request_buffering off;
#
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
#     }
#
#     location /health {
#         proxy_pass http://transcription_backend;
#         proxy_read_timeout 10s;
#         proxy_connect_timeout 10s;
#         access_log off;
#     }
# }
#
# # Redirecionar HTTP para HTTPS
# server {
#     listen 80;
#     server_name api.seudominio.com;
#     return 301 https://$server_name$request_uri;
# }
